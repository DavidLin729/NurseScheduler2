# 護理人員排班系統

## 專案簡介

本系統為醫療單位設計的護理人員排班管理工具，支援人員與班別管理、自動排班、班表查詢、樞紐分析、批次上傳/下載與多條件搜尋，並可依實務需求擴充。

---

## 主要功能
- **人員管理**（CRUD、病房分組、批次上傳/下載、篩選搜尋）
- **班別設定**（CRUD、病房欄位、批次上傳/下載）
- **特定人員排班偏好設定**（單一班別、雙班別週次模式）
- **假日 On Call 管理**（主要/備援 On Call、批次設定、月曆檢視）
- **自動排班**（支援進階規則：每日最多一班、連續上班天數、每月班數上下限、公平分配、缺人自動標註、排班偏好整合）
- **班表查詢**（多條件搜尋、查詢結果匯出CSV、On Call 狀態顯示）
- **班表分析**（PivotTable.js 樞紐分析，支援拖曳分析）
- **權限管理**（管理員/護理人員角色權限分級）
- **班表異動紀錄**（完整稽核追蹤）
- 所有資料皆儲存於 SQLite，資料結構可擴充

---

## 安裝與啟動

1. **安裝 Python 3.8+**
2. **安裝必要套件**
   ```bash
   pip install -r requirements.txt
   ```
3. **啟動 Flask 伺服器**
   ```bash
   python app.py
   ```
4. **瀏覽器開啟**
   http://127.0.0.1:5000/

---

## 使用說明

### 基本操作流程
1. **登入系統**：使用管理員或護理人員帳號登入
2. **人員管理**：新增、編輯護理人員資料，設定病房分組
3. **班別設定**：定義各種班別（早班、小夜班、大夜班等）
4. **排班偏好設定**：為特定人員設定當月排班偏好（單一班別或雙班別週次模式）
5. **假日 On Call 管理**：設定週末與假日的 On Call 人員安排
6. **自動排班**：一鍵產生整月班表，系統會自動遵循排班偏好與規則
7. **班表查詢**：多條件搜尋班表，查看 On Call 狀態
8. **班表分析**：使用樞紐分析工具進行深度分析

### 進階功能
- **批次處理**：支援 CSV 格式的批次上傳/下載
- **月曆檢視**：FullCalendar.js 呈現班表，支援月份切換
- **異動追蹤**：所有班表編輯都會記錄在異動紀錄中
- **權限控管**：依角色顯示不同功能選單

---

## 專案規劃與開發日誌

請參閱 [DEVLOG.md](DEVLOG.md) 取得完整專案規劃、已完成功能與下一階段建議。

---

## 貢獻方式

歡迎 issue、pull request 或 fork 本專案，協助功能優化與錯誤修正。

---

## 聯絡方式

如有合作或技術諮詢需求，請於 GitHub issue 留言。

## 最新功能 (v2.1.0)

### 🎯 **四周變形工時與每日需求人數功能**
- **四周變形工時管理系統**：
  - 支援每月四周變形工時設定（預設啟用）
  - 每人每週工時不超過40小時
  - 可自訂例假日（預設週日，可調整為其他星期）
  - 自動安排例假日與休息日
  - 工時統計與警示功能
- **班別每日需求人數設定**：
  - 支援每個班別在週一到週日的不同需求人數
  - 保留原有「所需人數」作為預設值
  - 支援「複製到所有天數」與「重置為預設值」功能
  - 向後相容現有資料
- **週工時統計與警示系統**：
  - 新增「週工時統計」專頁
  - 顏色編碼顯示工時狀態（紅色超限、橘色不足、綠色正常）
  - 顯示工作天數、例假日、休息日統計
  - 警示缺少例假日或休息日

### 🎯 **特定規則功能**
- **特定人員排班偏好設定**：
  - 支援單一班別偏好（指定人員只值勤特定班別）
  - 支援雙班別偏好（指定人員值勤兩種班別）
  - 週次模式：交替週次（奇數週班別1，偶數週班別2）、連續週次（前兩週班別1，後兩週班別2）
- **假日 On Call 管理系統**：
  - 主要 On Call、備援 On Call、休息狀態管理
  - 批次自動分配週末 On Call
  - 月曆檢視，週末日期自動高亮顯示
  - 與班表查詢整合，顯示 On Call 狀態

### 🔧 **自動排班邏輯升級**
- 自動檢查人員排班偏好設定
- 支援週次模式自動分配
- 保持原有規則（11小時間隔、連續天數限制等）
- 資料完整性保護（只處理指定月份）

### 📊 **介面優化**
- 新增「排班偏好設定」與「假日 On Call 管理」專用頁面
- 班表查詢新增 On Call 狀態欄位
- 自動排班頁面新增「假日 On Call 整合」選項
- 保持淺粉紅主題色彩一致性

## 技術棧
- Python Flask
- Bootstrap 5
- FullCalendar.js（行事曆）
- PivotTable.js（樞紐分析）
- SQLite（資料儲存）

## 主要特色
- **人員/班別管理**（CRUD、批次上傳/下載、篩選搜尋）
- **特定人員排班偏好**（單一班別、雙班別週次模式）
- **假日 On Call 管理**（主要/備援 On Call、批次設定、月曆檢視）
- **進階自動排班**（多規則、依病房分組、缺人自動標註、排班偏好整合）
- **班表查詢**（多條件搜尋、CSV匯出、On Call 狀態顯示）
- **月曆檢視**（FullCalendar，支援月份切換）
- **班表分析**（PivotTable.js）
- **權限管理**（管理員/護理人員角色權限分級）
- **班表異動紀錄**（完整稽核追蹤）
- **本月班數統計與警示**

## 下一步建議

### 短期優化（1-2週）
- On Call 與排班深度整合
- 偏好衝突檢查與報表功能
- On Call 提醒通知系統

### 中期發展（1-2個月）
- 進階偏好設定（更複雜的排班模式）
- 歷史資料分析與自動化建議
- 行動裝置響應式設計完善

### 長期規劃（3-6個月）
- AI 輔助排班（機器學習優化）
- 多院區支援與 API 整合
- 雲端部署與擴展

### 近期更新
- 班表分析頁面美化，活力綠主題、標題、說明、匯出CSV按鈕，PivotTable.js 介面現代化。
- 全站主色調改為淺粉紅，首頁及所有子頁面背景、標題、卡片、按鈕皆統一色系。
- 員工橫式排班表優化：日期下方新增星期，早班/小夜班/大夜班以不同底色顯示。
- 各頁按鈕與導覽動線優化：「員工橫式排班表」按鈕移至班表查詢頁「月曆檢視」右側，回首頁/回上一頁按鈕動線更直覺。
- staff頁面「批次上傳」「範本下載」按鈕版面與shift頁一致，並支援點擊自動上傳。
- staff頁面新增「篩選搜尋」功能，可依員工編號、姓名、職稱、病房即時過濾。
- 其他UI一致性優化與細節調整。
- 2025-06-xx 權限管理與使用者管理功能開發進度：
  - 全站登入保護，未登入自動導向登入頁。
  - 依登入者角色（管理員/護理人員）顯示不同功能選單。
  - 首頁右上角顯示登入者名稱與登出按鈕。
  - 管理員專用「使用者管理」頁面：可新增、編輯、刪除、批次上傳/下載使用者。
  - 月曆檢視頁面新增「員工姓名、病房、班別」篩選查詢功能。

## 2025-06-xx 重大功能更新
- 新增 schedule_log（班表異動紀錄）資料表，所有班表編輯/刪除自動寫入異動紀錄。
- 班表查詢、月曆檢視頁新增「編輯」按鈕，管理員可直接編輯/刪除班表。
- 編輯班表彈窗（modal）優化：
  - 員工編號欄位支援 select2，可搜尋員工編號或姓名。
  - 權限控管，僅管理員可操作。
  - 狀態欄位改為下拉選單（正常、請假、調班、加班、缺勤、其他）。
- schedule_log 頁面可查詢所有異動紀錄，顯示異動前後內容。
- 修正 select2 在 modal 內無法搜尋的問題，改為每次 modal 彈出時初始化。
- 全站介面一致性優化，移除除錯欄位，保留乾淨操作體驗。
- 所有更新已 commit 並 push 至 GitHub。

---

## 最新功能 (v2.2.0) - 大夜班分配系統重大升級

### 🎯 **大夜班分配方式革新**
- **跨月份支援**：完全支援跨月份的大夜班分配（如：2024-01-30 至 2024-02-05）
- **靈活日期範圍**：使用者可自行輸入起始與結束日期，取代原有月份+週次模式
- **智慧型批次分配**：支援跨月份的批次分配，按週自動安排（週日-週四、週四-週六）
- **資料庫結構優化**：採用 `start_date` + `end_date` 模式，更簡潔靈活
- **自動資料遷移**：系統自動檢測並遷移舊有資料結構

### 🎨 **介面設計風格統一**
- **Bootstrap 5.3.0**：統一升級至最新版本，確保所有頁面一致性
- **粉色系主題**：統一採用淺粉色背景與深粉色主色調
- **標準化佈局**：統一按鈕群組、篩選區域、表格樣式
- **使用者體驗優化**：日期驗證、智慧提示、操作便利性

### 🔧 **技術特色**
- **複雜日期查詢**：支援重疊、包含、交集等多種日期範圍查詢
- **前端互動**：自動日期驗證、預設值設定、操作引導
- **向後相容**：確保舊有資料的平滑遷移與系統穩定性

---

## 版本歷史

### v2.2.0 (2024-12-27) - 大夜班分配系統重大升級
- ✅ 大夜班分配跨月份支援
- ✅ 靈活日期範圍分配模式
- ✅ 全站介面風格統一
- ✅ 資料庫結構優化與自動遷移
- ✅ 使用者體驗全面提升

### v2.1.0 (2025-06-xx) - 四周變形工時與每日需求人數
- ✅ 四周變形工時管理系統
- ✅ 班別每日需求人數設定
- ✅ 週工時統計與警示系統
- ✅ 資料庫結構擴充與遷移
- ✅ 介面整合與優化

### v2.0.0 (2025-06-xx) - 特定規則功能
- ✅ 特定人員排班偏好設定
- ✅ 假日 On Call 管理系統  
- ✅ 自動排班邏輯升級
- ✅ 介面整合與優化

### v1.x.x (2025-06-xx) - 基礎功能
- ✅ 權限管理與使用者管理
- ✅ 班表異動紀錄
- ✅ 月曆檢視功能
- ✅ 介面美化與優化

### v1.0.0 (2025-05-xx) - MVP 版本
- ✅ 人員/班別管理
- ✅ 自動排班（基礎規則）
- ✅ 班表查詢/分析
- ✅ CSV 匯入匯出 

## 系統排班邏輯說明（2024-06更新）

### 主要規則
1. 每天每個班別都會依照設定需求人數自動排班，確保無缺班。
2. 每位員工每週日（例假日）固定休假，僅排一位員工上大夜班，其餘班別週日不上班。
3. 每位員工每週隨機分配一天休息日（週一到週六），該天不排班。
4. 週一到週六依需求公平分配班別，盡量平均分配班數。
5. 若人力不足，允許同一人多排班，但不允許班別缺人。
6. 排班結果於橫式班表中顯示，例假日/休息日有明確標記。

### 其他功能
- 支援每日班別需求人數自訂。
- 支援四周變形工時、夜班限制、連續上班天數等進階規則。 